@using BlankBase.Data
@using BlankBase.Data.SortColumns

@{
    ViewData["Title"] = "Example Records - AJAX Pagination";
}

<div class="container mt-4">
    <h1>Example Records</h1>
    <p class="text-muted">Modern AJAX pagination with sortable columns and URL state management. Supports bookmarking, back/forward buttons, and page refresh. (Click column headers to sort)</p>

    <!-- Loading Spinner -->
    <div id="loading" class="text-center my-5 d-none" >
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading records...</p>
    </div>

    <!-- Error Message -->
    <div id="error" class="alert alert-danger d-none" ></div>

    <!-- No Records Message -->
    <div id="noRecords" class="alert alert-info d-none" >
        No records found. Add some records to see pagination in action.
    </div>

    <!-- Records Table -->
    <div id="tableContainer" class="d-none">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="sortable" data-column="@ExampleRecordSortColumns.ExampleRecordID" style="cursor: pointer;">
                            <span class="sort-header">ID <span class="sort-indicator"></span></span>
                        </th>
                        <th class="sortable" data-column="@ExampleRecordSortColumns.Name" style="cursor: pointer;">
                            <span class="sort-header">Name <span class="sort-indicator"></span></span>
                        </th>
                        <th class="sortable" data-column="@ExampleRecordSortColumns.Age" style="cursor: pointer;">
                            <span class="sort-header">Age <span class="sort-indicator"></span></span>
                        </th>
                        <th class="sortable" data-column="@ExampleRecordSortColumns.Birthdate" style="cursor: pointer;">
                            <span class="sort-header">Birthdate <span class="sort-indicator"></span></span>
                        </th>
                        <th class="sortable" data-column="@ExampleRecordSortColumns.IsActive" style="cursor: pointer;">
                            <span class="sort-header">Status <span class="sort-indicator"></span></span>
                        </th>
                    </tr>
                </thead>
                <tbody id="recordsTableBody">
                    <!-- Records will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Row Template (modify structure here - no JavaScript needed!) -->
        <template id="recordRowTemplate">
            <tr>
                <td data-glue="ExampleRecordID"></td>
                <td data-glue="Name"></td>
                <td data-glue="Age"></td>
                <td data-glue="BirthdateFormatted"></td>
                <td>
                    <span data-glue="StatusText" data-glue-attrs="class:StatusClass"></span>
                </td>
            </tr>
        </template>

        <!-- Pagination Info -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div id="paginationInfo" class="text-muted"></div>
            <div id="pageInfo" class="text-muted"></div>
        </div>

        <!-- Pagination Controls -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="paginationControls">
                <!-- Pagination buttons will be inserted here by JavaScript -->
            </ul>
        </nav>
    </div>

    <!-- Links to Other Examples -->
    <hr class="my-4" />
    <div class="d-flex gap-2">
        <a href="@Url.Action(nameof(ExampleRecordController.Index), Name<ExampleRecordController>.Value)" class="btn btn-outline-primary">
            View Traditional Pagination Example
        </a>
        <a href="@Url.Action(nameof(HomeController.Index), Name<HomeController>.Value)" class="btn btn-outline-secondary">
            Back to Home
        </a>
    </div>
</div>

@section Scripts {
    <script src="~/js/pagination.js"></script>
    <script>
        // Sort direction constants (rendered from C# constants)
        const ASC = '@SortDirections.Asc';
        const DESC = '@SortDirections.Desc';

        // Default values
        const DEFAULT_SORT_BY = '@ExampleRecordSortColumns.Name';
        const DEFAULT_SORT_DIRECTION = ASC;

        // Current sort state (will be initialized from URL)
        let currentSortBy = DEFAULT_SORT_BY;
        let currentSortDirection = DEFAULT_SORT_DIRECTION;
        const pageSize = 10;

        // Initialize reusable pagination component with integrated sorting
        const pagination = new AjaxPagination({
            controlsContainer: 'paginationControls',
            infoContainer: 'paginationInfo',
            pageInfoContainer: 'pageInfo',
            onPageChange: (page, sortBy, sortDirection) => loadRecords(page, sortBy, sortDirection),
            urlParams: { page: 'page', sortBy: 'sortBy', sortDirection: 'sortDirection' },
            defaults: { page: 1, sortBy: DEFAULT_SORT_BY, sortDirection: DEFAULT_SORT_DIRECTION },
            sorting: {
                enabled: true,
                headerSelector: '.sortable',
                columnAttribute: 'data-column',
                sortConstants: { asc: ASC, desc: DESC },
                indicators: { asc: ' ▲', desc: ' ▼', none: '' }
            }
        });

        // Load records from API
        async function loadRecords(page, sortBy = null, sortDirection = null) {
            // Update sort state if provided
            if (sortBy !== null) currentSortBy = sortBy;
            if (sortDirection !== null) currentSortDirection = sortDirection;

            try {
                // Show loading spinner
                Dom.show('#loading');
                Dom.hide('#error');
                Dom.hide('#noRecords');
                Dom.hide('#tableContainer');

                // Fetch data with sort parameters
                const response = await fetch(`@Url.Action(nameof(ExampleRecordController.GetRecordsJson), Name<ExampleRecordController>.Value)?page=${page}&pageSize=${pageSize}&sortBy=${currentSortBy}&sortDirection=${currentSortDirection}`);

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }

                const data = await response.json();

                // Hide loading spinner
                Dom.hide('#loading');

                // Check if there are records
                if (data.items.length === 0) {
                    Dom.show('#noRecords');
                    return;
                }

                // Render table (page-specific)
                renderTable(data.items);

                // Render pagination controls and sort indicators (reusable component)
                pagination.render(data.pagination, currentSortBy, currentSortDirection);

                // Show table
                Dom.show('#tableContainer');

            } catch (error) {
                console.error('Error loading records:', error);
                Dom.hide('#loading');
                Dom.show('#error');
                Dom.get('#error').textContent = `Failed to load records: ${error.message}`;
            }
        }

        // Render table rows using template (structure defined in HTML template above)
        function renderTable(items) {
            Gluer.glueUp('recordRowTemplate', 'recordsTableBody', items);
        }

        // Initialize and load first page
        Dom.whenLoaded(() => {
            // Read initial state from URL (supports bookmarking and refresh)
            const initialState = pagination.getStateFromUrl();
            currentSortBy = initialState.sortBy;
            currentSortDirection = initialState.sortDirection;

            // Load page with state from URL
            loadRecords(initialState.page, currentSortBy, currentSortDirection);
        });
    </script>
}
