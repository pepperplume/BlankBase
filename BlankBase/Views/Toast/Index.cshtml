@using BlankBase.Extensions
@using System.Text.Json
@using System.Text.Json.Serialization
@{
    ViewData["Title"] = "Toast Demo";
    var toasts = TempData.GetToasts();
    var jsonOptions = new JsonSerializerOptions
    {
        Converters = { new JsonStringEnumConverter() }
    };
}

<div class="row">
    <div class="col-md-6">
        <h1>Toast Message Demo</h1>
        <p>Use the form below to trigger Bootstrap toast notifications with custom settings.</p>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Toast Configuration</h5>
                <form id="toastForm">
                    <div class="mb-3">
                        <label class="form-label">Trigger Mode</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="triggerMode" id="modeJavaScript" value="javascript" checked>
                            <label class="form-check-label" for="modeJavaScript">
                                JavaScript (Client-side only)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="triggerMode" id="modePost" value="post">
                            <label class="form-check-label" for="modePost">
                                POST (Submit to server via AJAX)
                            </label>
                        </div>
                        <div class="form-text">Choose whether to trigger the toast directly or via a server POST request</div>
                    </div>

                    <div class="mb-3">
                        <label for="messageText" class="form-label">Message Text</label>
                        <input type="text" class="form-control" id="messageText" name="messageText" value="This is a toast notification!" />
                    </div>

                    <div class="mb-3">
                        <label for="messageType" class="form-label">Message Type</label>
                        <select class="form-select" id="messageType" name="messageType">
                            <option value="success">Success</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="duration" class="form-label">Duration (milliseconds)</label>
                        <input type="number" class="form-control" id="duration" name="duration" value="3000" min="1000" step="500" />
                        <div class="form-text">How long the toast should be displayed (e.g., 3000 = 3 seconds)</div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="autoHide" name="autoHide" checked />
                        <label class="form-check-label" for="autoHide">
                            Auto Hide
                        </label>
                        <div class="form-text">If unchecked, toast will remain visible until manually closed</div>
                    </div>

                    <button type="button" class="btn btn-primary" onclick="triggerToast()">Show Toast</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer">
    <!-- Toasts will be dynamically inserted here -->
</div>

@section Scripts {
    <script>
        // Check for toast data from TempData on page load
        document.addEventListener('DOMContentLoaded', function() {
            @if (toasts.Any())
            {
                <text>
                // Array of toast notifications from server
                const toasts = @Html.Raw(JsonSerializer.Serialize(toasts, jsonOptions));

                // Display each toast (note: property names are PascalCase from C# serialization)
                toasts.forEach((toast, index) => {
                    showToast(toast.MessageText, toast.MessageType, toast.Duration, toast.AutoHide);
                });
                </text>
            }
        });

        function triggerToast() {
            // Get the selected mode
            const mode = document.querySelector('input[name="triggerMode"]:checked').value;

            if (mode === 'javascript') {
                // JavaScript mode: trigger directly
                triggerToastJavaScript();
            } else {
                // POST mode: submit via AJAX
                triggerToastPost();
            }
        }

        function triggerToastJavaScript() {
            // Get form values
            const messageText = document.getElementById('messageText').value;
            const messageType = document.getElementById('messageType').value;
            const duration = parseInt(document.getElementById('duration').value);
            const autoHide = document.getElementById('autoHide').checked;

            // Show the toast
            showToast(messageText, messageType, duration, autoHide);
        }

        function triggerToastPost() {
            // Get form values explicitly
            const messageText = document.getElementById('messageText').value;
            const messageType = document.getElementById('messageType').value;
            const duration = parseInt(document.getElementById('duration').value);
            const autoHide = document.getElementById('autoHide').checked;

            // Create payload
            const payload = {
                messageText: messageText,
                messageType: messageType,
                duration: duration,
                autoHide: autoHide
            };

            // Submit via AJAX
            fetch('@Url.Action("ShowToast", "Toast")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                // Trigger toast with data from server
                showToast(data.messageText, data.messageType, data.duration, data.autoHide);
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error communicating with server', 'error', 3000, true);
            });
        }

        function showToast(messageText, messageType, duration, autoHide) {
            // Create toast element
            const toastId = 'toast-' + Date.now();
            const toast = createToastElement(toastId, messageText, messageType);

            // Append to container
            document.getElementById('toastContainer').appendChild(toast);

            // Initialize and show the toast
            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement, {
                autohide: autoHide,
                delay: duration
            });

            bsToast.show();

            // Remove toast from DOM after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        function createToastElement(id, message, type) {
            // Determine colors and icon based on message type
            // Note: type comes from C# ToastType enum serialized as string (e.g., "Success", "Warning", "Error")
            let bgClass = '';
            let icon = '';
            let title = '';

            switch (type) {
                case 'Success':
                case 'success':
                    bgClass = 'bg-success text-white';
                    icon = '✓';
                    title = 'Success';
                    break;
                case 'Warning':
                case 'warning':
                    bgClass = 'bg-warning';
                    icon = '⚠';
                    title = 'Warning';
                    break;
                case 'Error':
                case 'error':
                    bgClass = 'bg-danger text-white';
                    icon = '✕';
                    title = 'Error';
                    break;
            }

            // Create toast HTML
            const toastDiv = document.createElement('div');
            toastDiv.id = id;
            toastDiv.className = 'toast';
            toastDiv.setAttribute('role', 'alert');
            toastDiv.setAttribute('aria-live', 'assertive');
            toastDiv.setAttribute('aria-atomic', 'true');

            toastDiv.innerHTML = `
                <div class="toast-header ${bgClass}">
                    <strong class="me-auto">${icon} ${title}</strong>
                    <button type="button" class="btn-close ${type === 'warning' ? '' : 'btn-close-white'}" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;

            return toastDiv;
        }
    </script>
}
